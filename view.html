<!doctype html><meta charset=utf-8>
<meta name=viewport content="width=device-width, height=device-height, initial-scale=1" id=$meta_viewport>

<!--<link rel=preload as=image type='image/svg+xml' href='defs.svg'>-->

<title>twemoji viewer</title>

<style>
	html, body {
		position: fixed;
		inset: 0;
	}
	html, body, form, .scroll {
		background: white;
	}
	body {
		display: grid;
		grid-template:
			'form form' max-content
			'compare layers' 1fr
			/ auto 1fr;
		gap: 8px;
	}
	.scroll {
		overflow-y: scroll;
	}
	form {
		overflow: hidden;
		grid-area: form;
	}
	:root {
		font-family: ms pmincho;
	}
	* {
		font-family: unset;
		font-size: unset;
		word-wrap: break-word;
	}
	* {
		appearance: none;
	}
	@keyframes dash {
		from {
			stroke-dashoffset: 0;
		}
		from {
			stroke-dashoffset: 2;
		}
	}
	
/*	use {
		stroke: #08F;
		stroke-width: 0.5px;
		stroke-dasharray: 0.5;
		stroke-dashoffset: 0;
		stroke-linejoin: bevel;
		animation: dash 1s linear infinite;
		fill: linear-gradient(red, blue);
	}*/
	input {
		min-width: 1em;
		vertical-align: middle;
		height: 1.2em;
	}
	input[type=checkbox], input[type=range] {
		appearance: auto;
	}
	
	.compare-box {
		display: grid;
		background: white;
		contain: content;
	}
	.compare-box > * {
		grid-area: 1/1/1/1;
		width: 360px;
		aspect-ratio: 1/1;
		background: white;
		border: 5px solid blue;
		contain: strict;
	}
	.compare-box > :last-child {
		/background: unset;
	}
	.compare-box > .mine {
		border: 5px dotted blue;
	}
	.compare-box.diff > .mine {
		mix-blend-mode: difference;
	}
	.compare-box.glass > svg * {
		fill-opacity: 0.5 !important;
		/*stroke-opacity: 0.5;
		filter: drop-shadow(.1px .1px) drop-shadow(-.1px -.1px);*/
		stroke: #C0A !important;
		stroke-width: 0.2 !important;
	}
	.compare-box.showold > .mine, .compare-box.showolder > .mine {
		opacity: 0;
		z-index: -5;
	}
	.compare-box.showolder > .svg-old {
		opacity: 0;
		z-index: -5;
	}
	.field-table {
		display: inline-grid;
		grid-template-columns: auto auto auto auto auto;
		column-gap: 0.75ch;
		row-gap: 2px;
		align-items: center;
		margin-bottom: 0.5em;
	}
	.field-table > label {
		display: contents;
	}
	.field-table > label > span {
		text-align: right;
		font-weight: bold;
	}
	.field-table > label > :last-child {
		grid-column: 2/-1;
	}
	output {
		/*font-family: courier, monospace;*/
		/*font-size: 14px;*/
		border: 1px solid gray;
		/*background: indigo;
			color: yellow;*/
		background: midnightblue;
		color: white;
		font-weight: bold;
		display: block;
		line-height: 1.2em;
		padding: 0 3px;
		line-break: anywhere;
		white-space: pre-wrap;
	}
	output::after {
		content: ""
	}
	
	.layer-box {
		line-break: anywhere;
		display: grid;
		grid-template:
			'svg row1' auto
		'svg row2' auto
			/ auto 150px;
		margin: 4px;
		column-gap: 4px;
		padding-right: 4px;
		background: linear-gradient(to left, white -10px , var(--color) 400% );
		border-left: 12px solid white;
		background-clip: padding-box;
		--color: gray;
	}
	.layer-box[data-shared] {
		--color: yellowgreen;
	}
	.layer-box[data-kind=use] {
		--color: blue;
	}
	.layer-box[data-kind=ellipse], .layer-box[data-kind=circle], .layer-box[data-kind=rect] {
		--color: teal;
	}
	.layer-box[data-kind=use] > svg{
		border-color: slateblue;
		/*deepskyblue;*/
		/*border-radius: 10px;*/
	}
	.layer-box[data-hidden] {
		opacity: 0.2;
		--color: black !important;
	}
	.layer-box > svg {
		grid-area: svg;
		background: white;
		border: solid; /*var(--color);*/
		width: 36px;
		height: 36px;
		paint-order: stroke;
		stroke: black;
		stroke-width: 2px;
		vector-effect: non-scaling-stroke;
		margin: -1px;
		margin-left: -12px;
		border-radius: 5px;
	}
	#\$layers {
		place-self: stretch start;
	}
	.layer-genders {
		background: #A804;
		padding: 0 0.5ch;
	}
	
	.color-square {
		display: inline-block;
		vertical-align: top;
		width: 1em;
		height: 1em;
		background-color: currentColor;
		margin-right: 3px;
		border: 1px solid black;
		box-sizing: border-box;
	}
</style>

<body>

<form method=dialog id=$form autocomplete="off">
	<div class='field-table'>
		<label>
			<span>Name:</span><input onkeydown="if (event.key=='1') { let old = cmap.findIndex(x=>x.ident==this.value) ; this.value = cmap[old+1]?.ident ; event.preventDefault() }" list=$emojinames name=name value="PersonBouncingBall" style='grid-column-end: -2'>
		</label>
		<label>
			<span>Variant:</span><input autocomplete="off" name=variant value="neutral" style='grid-column: span 1'>
		</label>
		<label>
			<span>Color:</span>
			<input min=0 max=25 type=number value="0" name=color style='grid-column: span 2'>
		</label>
		<button style='grid-area: 1/-2/1/-1'>Load</button>
		<label><span>modified:</span><output name=modified></output></label>
		<label><span>emoji:</span><output name=current></output></label>
		<label><span>encoding:</span><output name=codes></output></label>
		<label><span>twemoji file:</span><output name=filename></output></label>
	</div>
	<datalist id=$emojinames></datalist>
	<datalist id=$variants>
		<option value="neutral"></option>
		<option value="male"></option>
		<option value="female"></option>
		<option value="mixed"></option>
	</datalist>
</form>
<div>
	<form id=$controls method=dialog autocomplete=off>
		<label>Show: <input type=range min=-1 max=2 name=diff></label>
		<label>Glass: <input type=checkbox name=glass></label>
		<!--<label>Original<input autocomplete=off type=checkbox name=hide></label>
		<label>Difference<input autocomplete=off type=checkbox name=diff></label>-->
	</form>
	<div id=$box class='compare-box'>
		<br>
		<br>
		<br>
		<!--<svg viewBox="0 0 36 36" id=$custom></svg>-->
	</div>
	<form onsubmit="$custom.innerHTML=this.t.value;return undefined" method=dialog onkeydown="if (event.key=='Enter' && !event.shiftKey) event.preventDefault(),this.submit.click()">
		<textarea name=t style="width:100%;line-break:anywhere;width:-moz-available;display:block;"></textarea>
		<br>
		<button name=submit>update</button>
	</form>
</div>
<div id=$layers class='scroll'></div>

<script>
	window.onerror = (message, source, line, col, error)=>{
		alert('error:\n'+line+" : "+col+" in "+source+"\n\n"+message)
	}
	let IOS_SAFARI = CSS.supports('-webkit-touch-callout', 'none')
	if (IOS_SAFARI)
		$meta_viewport.content += ", user-scalable=no"
</script>

<script type=module>
	import cmap from './cmap.js?1' // todo: use the async syntax trick
	import palette from './palette.js?1'
	
	//let custom = $custom
	
	window.cmap = cmap
	
	for (let item of cmap) {
		//if (item.gender || item.skin)
		//console.log(item)
		$emojinames.append(new Option(item.ident + String.fromCodePoint(...(item.codes ?? item.variants.neutral[0])[0]),item.ident))
	}
	
	window.TWEMOJI_BASE = null
	if (location=='file:///home/twelve/Code/twemoji-COLR/ts/view.html') {
		window.TWEMOJI_BASE = '../twemoji/assets/svg/'
		window.TWEMOJI_BASE2 = '../twemoji/2.4/svg/'
	}
	
	let box_items = [...$box.children]
	let box_items0 = [...$box.children]
	
	$form.onsubmit = function(ev) {
		window.go(this.name.value, this.variant.value, this.color.value)
	}
	$controls.oninput = function(ev) {
		let v = this.diff.value
		$box.classList.toggle('showolder', v==-1)
		$box.classList.toggle('showold', v==0)
		$box.classList.toggle('diff', v==2)
		$box.classList.toggle('glass', this.glass.checked)
	}
	
	function load(file, a=false) {
		console.warn('loading', file)
		let x = new XMLHttpRequest()
		x.open('GET', file, a)
		x.send()
		if (!a)
			return x.responseXML
		return new Promise((y,n)=>{
			x.onload = function(ev) { y(this.responseXML) }
			x.onerror = function(ev) { n(x) }
		})
	}
	
	let HTML = ([html])=>{
		let temp = document.createElement('template')
		temp.innerHTML = html.replace(/\s*?\n\s*/g, "")
		let content = temp.content
		let root = content
		if (root.childNodes.length==1)
			root = root.firstChild
		
		let get_path = (root, node)=>{
			let path = ""
			while (node!==root) {
				let parent = node.parentNode
				let pos = [].indexOf.call(parent.childNodes, node)
				path = ".firstChild"+".nextSibling".repeat(pos) + path
				node = parent
			}
			return path
		}
		
		let init = `const node=document.importNode(this, true)\nholder.$root=node`
		for (let node of content.querySelectorAll("[\\$]")) {
			let path = get_path(root, node)
			let id = node.getAttribute('$')
			node.removeAttribute('$')
			id = id.replace(/,/g, " = holder.$")
			init += `\nholder.$${id} = node${path}`
		}
		init += `\nreturn holder`
		let c = new Function("holder={}", init).bind(root)
		//c.prototype = {__proto__: null, template: root}
		return c
	}

	
	function clear() {
		$box.replaceChildren(...box_items0)
		box_items = box_items0.slice(0)
		$layers.textContent = ""
		$form.modified.value = ""
		$form.current.value = ""
		$form.codes.value = ""
		$form.filename.value = ""
	}
	
	let layer = HTML`
<div class='layer-box'>
	<div $=row1></div>
	<div $=row2><div $=variants class='layer-genders' style='float:right'></div></div>
</div>
	`
	
	function show_layers(svg) {
		$layers.textContent = ""
		for (let elem of svg.querySelectorAll('*:not(g,svg)')) {
			if (elem.style.display=="none")
				//box.$root.dataset.hidden = ""
				continue
			let box = layer()
			let svg2 = svg.cloneNode(false)
			svg2.append(elem.cloneNode(true))
			box.$root.prepend(svg2)
			
			box.$root.dataset.kind = elem.nodeName
			
			let sym 
			if (elem.nodeName=="use") {
				sym = (elem.hasAttribute('transform') ? "t*" : "*") + " " + elem.getAttribute('href').split("#")[1] + ""
				
			} else {
				sym = "<"+elem.nodeName+">"
				if (elem instanceof SVGPathElement)
					sym += " ("+elem.getAttribute('d').length+")"
			}
			box.$row1.append(sym)
			
			let g = elem.getAttribute('ts:gender')
			if (g) {
				g = g.split(/[, ]/)
				box.$variants.append(" "+g.map(x=>({neutral:'X',male:'M',female:'F',mixed:'2'}[x])).join(""))
			} else
				box.$root.dataset.shared = ""

			
			let skin = elem.getAttribute('ts:skin')
			if (skin) {
				box.$row2.append("🎨︎ "+skin+"")
			} else {
				let col = elem.getAttribute('fill')
				if (!col || col=="none")
					 col = elem.getAttribute('stroke')
				let cs = document.createElement('div')
				cs.classList.add('color-square')
				cs.style.color = col
				box.$row2.append(cs, col)
			}
			box.$root.onpointerenter = ev=>{
				elem.style.filter = 'drop-shadow(0px 0px 0.2px red)'
			}
			box.$root.onpointerleave = ev=>{
				elem.style.filter = ''
			}
			$layers.append(box.$root)
			//▬●⬬ ▭⬭○ ▢ ⬤⬛
		}
	}
	
	let gen = 0
	
	window.go = function(name, variant, palette) {
		let ok
		try {
			$form.modified.value = "loading..."
			variant = variant || 'neutral'
			palette = palette || 0
			//
			let item = cmap.find(x=>x.ident==name)
			if (!item)
				return
			let codes
			if (item.variants) {
				codes = item.variants?.[variant]?.[palette]
			} else {
				codes = item.codes
			}
			if (!codes)
				return
			//
			
			if (TWEMOJI_BASE) {
				gen++
				let gen2 = gen
				load(TWEMOJI_BASE+codes[1]+'.svg', true).then(doc=>{
					if (gen!=gen2) return
					doc = doc.documentElement
					doc.classList.add('svg-old')
					box_items[1].replaceWith(box_items[1] = doc)
				}, ()=>{})
				load(TWEMOJI_BASE2+codes[1]+'.svg', true).then(doc=>{
					if (gen!=gen2) return
					doc = doc.documentElement
					box_items[0].replaceWith(box_items[0] = doc)
					let c = doc.querySelectorAll('clipPath')
					if (c && c.length>1)
						console.info('clip path!', c)
				}, ()=>{})
			}
			
			let svg = load('./simple/'+name+'.svg')
			let modified = svg.lastModified
			svg = svg.documentElement
			select_variant(svg, variant, palette)
			//
			clear()
			
			//
			//console.log(svg, orig)
			
			$form.modified.value = modified + " - " + ((Date.now() - new Date(modified)) / 1000 / 60).toFixed(0) + " minutes ago"
			svg.classList.add('mine')
			box_items[2].replaceWith(box_items[2] = svg)
//			$box.append(custom)
			//$controls.name.value = name
			//$controls.variant.value = variant
			$form.current.value = name+" / "+variant+" / "+palette
			$form.codes.value = codes[0].join(" ").replace(/0x/g,"")
			$form.filename.value = codes[1]+".svg"
			show_layers(svg)
			ok = true
		} finally {
			if (!ok) {
				//$box.replaceChildren()
				gen++
				clear()
			}
		}
	}
	
	function correct(i, hack) {
		if (!hack)
			return [0,1,12,19,20,21,22,23,24,25,2,3,4,5,6,7,8,9,10,11,13,14,15,16,17,18][i]
		return [0,1,2,3,4,5,7,6,8,9,10,12,13,11,14,15,17,18,19,16,20,22,23,24,25,21][i]
	}
	// 6,7,11,12,13,16,17,18,19,21,22,23,24,25,26
	
	const xmlns = 'data:,a'
	
	function select_variant(svg, gender, skin) {
		for (let elem of svg.getElementsByTagName('*')) {
			let g = elem.getAttributeNS(xmlns,'gender')
			let gc = elem.getAttributeNS(xmlns,'gender-color')
			let s = elem.getAttributeNS(xmlns,'skin')
			let s2 = elem.getAttributeNS(xmlns,'skin2')
			let second = s2
			if (second) {
				s = s2
			}
				
			if (g) {
				g = g.split(/[,| ]/)
				elem.style.setProperty('display', g.includes(gender) ? '' : 'none')
			}
			let fill
			if (gc) {
				gc = gc.split(/[| ,]/)
				if (gender=='male')
					fill = gc[0]
				if (gender=='female')
					fill = gc[1]
			}
			skin: if (s) {
				if (s=="eyes")
					s = gender=="neutral" ? "eyes2" : "eyes1"
				if (s=="mouth")
					s = (second && gender=="mixed" || gender=="female") ? "lips" : "nose"
				let ofs = 0
				if (palette[s]) {
					s = palette[s]
					if (!skin) {
						fill = s[0]
						break skin
					}
					ofs = 1
				} else {
					if (!skin)
						break skin
					s = s.split(/[| ,]/)
				}
				let skin1 = skin || 0
				if (second)
					skin1 = Math.floor((skin1-1) / 5)
				else
					skin1 = (skin1-1) % 5
				
				fill = s[skin1 + ofs]
			}
			elem.style.setProperty('fill', fill || '')
		}
	}
</script>
